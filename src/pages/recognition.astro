---
import Layout from '../layouts/Layout.astro';
---

<Layout title="å…‰ä¼å›¾åƒè¯†åˆ« - æ™ºèƒ½è¯†åˆ«å…‰ä¼æ¿çŠ¶æ€å’Œé®æŒ¡ç‰©">
  <div class="min-h-screen bg-gray-50 py-8">
    <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
      <!-- é¡µé¢æ ‡é¢˜ -->
      <div class="text-center mb-8">
        <h1 class="text-3xl md:text-4xl font-bold text-gray-900 mb-4">
          å…‰ä¼å›¾åƒè¯†åˆ«
        </h1>
        <p class="text-lg text-gray-600 max-w-2xl mx-auto">
          ä¸Šä¼ å…‰ä¼æ¿å›¾ç‰‡ï¼ŒAIå°†è‡ªåŠ¨è¯†åˆ«å…‰ä¼æ¿çŠ¶æ€ã€é®æŒ¡ç‰©ç±»å‹ï¼Œå¹¶æä¾›ä¸“ä¸šçš„æ¸…æ´å»ºè®®
        </p>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- å·¦ä¾§ï¼šä¸Šä¼ åŒºåŸŸ -->
        <div class="space-y-6">
          <!-- ä¸Šä¼ å¡ç‰‡ -->
          <div class="card">
            <div class="card-header">
              <h2 class="text-lg font-semibold text-gray-900">ä¸Šä¼ å›¾ç‰‡</h2>
              <p class="text-sm text-gray-600 mt-1">æ”¯æŒ JPGã€PNGã€WebP æ ¼å¼ï¼Œæœ€å¤§ 10MB</p>
            </div>
            <div class="card-body">
              <!-- ä¸Šä¼ åŒºåŸŸ -->
              <div id="upload-area" class="upload-area">
                <div class="text-center">
                  <svg class="w-12 h-12 text-gray-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                  </svg>
                  <p class="text-lg font-medium text-gray-900 mb-2">æ‹–æ‹½å›¾ç‰‡åˆ°æ­¤å¤„æˆ–ç‚¹å‡»ä¸Šä¼ </p>
                  <p class="text-sm text-gray-500">æ”¯æŒ JPGã€PNGã€WebP æ ¼å¼</p>
                  <input type="file" id="file-input" class="hidden" accept="image/*" />
                </div>
              </div>
              
              <!-- å›¾ç‰‡é¢„è§ˆ -->
              <div id="image-preview" class="hidden mt-4">
                <img id="preview-img" class="w-full h-64 object-cover rounded-lg" alt="é¢„è§ˆå›¾ç‰‡" />
                <div class="mt-4 flex justify-between items-center">
                  <div>
                    <p id="file-name" class="text-sm font-medium text-gray-900"></p>
                    <p id="file-size" class="text-sm text-gray-500"></p>
                  </div>
                  <button id="remove-image" class="btn btn-danger text-sm">
                    ç§»é™¤å›¾ç‰‡
                  </button>
                </div>
              </div>
            </div>
            <div class="card-footer">
              <button id="start-recognition" class="btn btn-solar w-full" disabled>
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                </svg>
                å¼€å§‹è¯†åˆ«
              </button>
            </div>
          </div>

          <!-- è¯†åˆ«è¿›åº¦ -->
          <div id="recognition-progress" class="card hidden">
            <div class="card-body">
              <div class="text-center">
                <div class="loading-spinner mx-auto mb-4"></div>
                <h3 class="text-lg font-semibold text-gray-900 mb-2">AIæ­£åœ¨åˆ†æå›¾ç‰‡...</h3>
                <p class="text-gray-600 mb-4">è¯·ç¨å€™ï¼Œè¿™é€šå¸¸éœ€è¦å‡ ç§’é’Ÿæ—¶é—´</p>
                <div class="progress-bar">
                  <div id="progress-fill" class="progress-fill" style="width: 0%"></div>
                </div>
                <p id="progress-text" class="text-sm text-gray-500 mt-2">å‡†å¤‡ä¸­...</p>
              </div>
            </div>
          </div>
        </div>

        <!-- å³ä¾§ï¼šè¯†åˆ«ç»“æœ -->
        <div class="space-y-6">
          <!-- è¯†åˆ«ç»“æœå¡ç‰‡ -->
          <div id="recognition-result" class="card hidden">
            <div class="card-header">
              <h2 class="text-lg font-semibold text-gray-900">è¯†åˆ«ç»“æœ</h2>
              <div class="flex items-center space-x-2">
                <div id="result-status" class="w-3 h-3 rounded-full"></div>
                <span id="result-status-text" class="text-sm font-medium"></span>
              </div>
            </div>
            <div class="card-body">
              <!-- æ•´ä½“ç½®ä¿¡åº¦ -->
              <div class="mb-6">
                <div class="flex items-center justify-between mb-2">
                  <span class="text-sm font-medium text-gray-700">æ•´ä½“ç½®ä¿¡åº¦</span>
                  <span id="overall-confidence" class="text-sm font-semibold"></span>
                </div>
                <div class="progress-bar">
                  <div id="confidence-bar" class="progress-fill"></div>
                </div>
              </div>

              <!-- è¯†åˆ«æ ‡ç­¾ -->
              <div class="mb-6">
                <h3 class="text-sm font-medium text-gray-700 mb-3">è¯†åˆ«æ ‡ç­¾</h3>
                <div id="recognition-tags" class="flex flex-wrap gap-2"></div>
              </div>

              <!-- è¯¦ç»†ç»“æœ -->
              <div class="mb-6">
                <h3 class="text-sm font-medium text-gray-700 mb-3">è¯¦ç»†ç»“æœ</h3>
                <div id="detailed-results" class="space-y-3"></div>
              </div>

              <!-- é®æŒ¡ç¨‹åº¦åˆ†æ -->
              <div class="mb-6">
                <h3 class="text-sm font-medium text-gray-700 mb-3">é®æŒ¡ç¨‹åº¦åˆ†æ</h3>
                <div id="coverage-analysis" class="p-4 rounded-lg"></div>
              </div>

              <!-- æ¸…æ´å»ºè®® -->
              <div>
                <h3 class="text-sm font-medium text-gray-700 mb-3">æ¸…æ´å»ºè®®</h3>
                <div id="cleaning-advice" class="p-4 bg-blue-50 rounded-lg">
                  <p class="text-sm text-blue-800"></p>
                </div>
              </div>
            </div>
            <div class="card-footer">
              <div class="flex space-x-3">
                <button id="save-result" class="btn btn-primary flex-1">
                  <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" />
                  </svg>
                  ä¿å­˜ç»“æœ
                </button>
                <button id="share-result" class="btn btn-secondary flex-1">
                  <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.367 2.684 3 3 0 00-5.367-2.684z" />
                  </svg>
                  åˆ†äº«ç»“æœ
                </button>
              </div>
            </div>
          </div>

          <!-- ä½¿ç”¨è¯´æ˜ -->
          <div class="card">
            <div class="card-header">
              <h2 class="text-lg font-semibold text-gray-900">ä½¿ç”¨è¯´æ˜</h2>
            </div>
            <div class="card-body">
              <div class="space-y-4">
                <div class="flex items-start space-x-3">
                  <div class="w-6 h-6 bg-primary-100 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5">
                    <span class="text-xs font-semibold text-primary-600">1</span>
                  </div>
                  <div>
                    <h3 class="text-sm font-medium text-gray-900">ä¸Šä¼ æ¸…æ™°å›¾ç‰‡</h3>
                    <p class="text-sm text-gray-600">ç¡®ä¿å…‰ä¼æ¿åœ¨å›¾ç‰‡ä¸­æ¸…æ™°å¯è§ï¼Œé¿å…æ¨¡ç³Šæˆ–è¿‡æš—</p>
                  </div>
                </div>
                
                <div class="flex items-start space-x-3">
                  <div class="w-6 h-6 bg-primary-100 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5">
                    <span class="text-xs font-semibold text-primary-600">2</span>
                  </div>
                  <div>
                    <h3 class="text-sm font-medium text-gray-900">ç­‰å¾…AIåˆ†æ</h3>
                    <p class="text-sm text-gray-600">AIå°†è‡ªåŠ¨è¯†åˆ«å…‰ä¼æ¿çŠ¶æ€å’Œé®æŒ¡ç‰©ç±»å‹</p>
                  </div>
                </div>
                
                <div class="flex items-start space-x-3">
                  <div class="w-6 h-6 bg-primary-100 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5">
                    <span class="text-xs font-semibold text-primary-600">3</span>
                  </div>
                  <div>
                    <h3 class="text-sm font-medium text-gray-900">æŸ¥çœ‹ç»“æœå»ºè®®</h3>
                    <p class="text-sm text-gray-600">è·å–è¯¦ç»†çš„è¯†åˆ«ç»“æœå’Œä¸“ä¸šçš„æ¸…æ´å»ºè®®</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- è¯†åˆ«è„šæœ¬ -->
  <script>
    // å…¨å±€å˜é‡
    let currentFile = null;
    let recognitionResult = null;

    // DOMå…ƒç´ 
    const uploadArea = document.getElementById('upload-area');
    const fileInput = document.getElementById('file-input');
    const imagePreview = document.getElementById('image-preview');
    const previewImg = document.getElementById('preview-img');
    const fileName = document.getElementById('file-name');
    const fileSize = document.getElementById('file-size');
    const removeImageBtn = document.getElementById('remove-image');
    const startRecognitionBtn = document.getElementById('start-recognition');
    const recognitionProgress = document.getElementById('recognition-progress');
    const progressFill = document.getElementById('progress-fill');
    const progressText = document.getElementById('progress-text');
    const recognitionResultDiv = document.getElementById('recognition-result');
    const resultStatus = document.getElementById('result-status');
    const resultStatusText = document.getElementById('result-status-text');
    const overallConfidence = document.getElementById('overall-confidence');
    const confidenceBar = document.getElementById('confidence-bar');
    const recognitionTags = document.getElementById('recognition-tags');
    const detailedResults = document.getElementById('detailed-results');
    const coverageAnalysis = document.getElementById('coverage-analysis');
    const cleaningAdvice = document.getElementById('cleaning-advice');
    const saveResultBtn = document.getElementById('save-result');
    const shareResultBtn = document.getElementById('share-result');

    // å·¥å…·å‡½æ•°
    function formatFileSize(bytes) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    function getConfidenceColor(confidence) {
      if (confidence >= 0.8) return 'text-success-600';
      if (confidence >= 0.6) return 'text-warning-600';
      return 'text-danger-600';
    }

    function getConfidenceText(confidence) {
      if (confidence >= 0.8) return 'é«˜';
      if (confidence >= 0.6) return 'ä¸­';
      return 'ä½';
    }

    function getTagClass(label) {
      switch (label) {
        case 'æ­£å¸¸å…‰ä¼æ¿': return 'tag-normal';
        case 'æ ‘å¶é®æŒ¡': return 'tag-leaf';
        case 'ç°å°˜è¦†ç›–': return 'tag-dust';
        case 'äº‘å½©é˜´å½±': return 'tag-cloud';
        default: return 'tag-other';
      }
    }

    // æ–‡ä»¶å¤„ç†
    function handleFile(file) {
      // éªŒè¯æ–‡ä»¶
      const maxSize = 10 * 1024 * 1024; // 10MB
      const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/webp'];
      
      if (!allowedTypes.includes(file.type)) {
        alert('åªæ”¯æŒ JPGã€PNGã€WebP æ ¼å¼çš„å›¾ç‰‡');
        return;
      }
      
      if (file.size > maxSize) {
        alert('å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡ 10MB');
        return;
      }

      currentFile = file;
      
      // æ˜¾ç¤ºé¢„è§ˆ
      const reader = new FileReader();
      reader.onload = (e) => {
        previewImg.src = e.target.result;
        fileName.textContent = file.name;
        fileSize.textContent = formatFileSize(file.size);
        imagePreview.classList.remove('hidden');
        startRecognitionBtn.disabled = false;
      };
      reader.readAsDataURL(file);
    }

    // äº‹ä»¶ç›‘å¬å™¨
    uploadArea.addEventListener('click', () => fileInput.click());
    
    uploadArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadArea.classList.add('dragover');
    });
    
    uploadArea.addEventListener('dragleave', () => {
      uploadArea.classList.remove('dragover');
    });
    
    uploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadArea.classList.remove('dragover');
      const files = e.dataTransfer.files;
      if (files.length > 0) {
        handleFile(files[0]);
      }
    });

    fileInput.addEventListener('change', (e) => {
      if (e.target.files.length > 0) {
        handleFile(e.target.files[0]);
      }
    });

    removeImageBtn.addEventListener('click', () => {
      currentFile = null;
      imagePreview.classList.add('hidden');
      startRecognitionBtn.disabled = true;
      recognitionResultDiv.classList.add('hidden');
      fileInput.value = '';
    });

    // æ¨¡æ‹Ÿè¯†åˆ«è¿‡ç¨‹
    async function simulateRecognition() {
      const steps = [
        { progress: 20, text: 'ä¸Šä¼ å›¾ç‰‡ä¸­...' },
        { progress: 40, text: 'å›¾ç‰‡é¢„å¤„ç†...' },
        { progress: 60, text: 'AIåˆ†æä¸­...' },
        { progress: 80, text: 'ç”Ÿæˆç»“æœ...' },
        { progress: 100, text: 'è¯†åˆ«å®Œæˆ' }
      ];

      for (const step of steps) {
        progressFill.style.width = step.progress + '%';
        progressText.textContent = step.text;
        await new Promise(resolve => setTimeout(resolve, 800));
      }
    }

    // ç”Ÿæˆæ¨¡æ‹Ÿè¯†åˆ«ç»“æœ
    function generateMockResult() {
      const labels = ['æ­£å¸¸å…‰ä¼æ¿', 'æ ‘å¶é®æŒ¡', 'ç°å°˜è¦†ç›–', 'äº‘å½©é˜´å½±'];
      const predictions = [];
      
      // éšæœºç”Ÿæˆ2-4ä¸ªè¯†åˆ«ç»“æœ
      const numPredictions = Math.floor(Math.random() * 3) + 2;
      const usedLabels = new Set();
      
      for (let i = 0; i < numPredictions; i++) {
        let label;
        do {
          label = labels[Math.floor(Math.random() * labels.length)];
        } while (usedLabels.has(label));
        
        usedLabels.add(label);
        predictions.push({
          label,
          confidence: Math.random() * 0.4 + 0.6 // 0.6-1.0
        });
      }
      
      return {
        status: 'success',
        predictions,
        confidence: predictions.reduce((sum, p) => sum + p.confidence, 0) / predictions.length,
        processing_time: Math.floor(Math.random() * 3000) + 2000,
        api_used: 'aliyun'
      };
    }

    // æ˜¾ç¤ºè¯†åˆ«ç»“æœ
    function displayResult(result) {
      recognitionResult = result;
      
      // çŠ¶æ€æŒ‡ç¤ºå™¨
      if (result.status === 'success') {
        resultStatus.className = 'w-3 h-3 rounded-full bg-success-500';
        resultStatusText.textContent = 'è¯†åˆ«æˆåŠŸ';
        resultStatusText.className = 'text-sm font-medium text-success-600';
      } else {
        resultStatus.className = 'w-3 h-3 rounded-full bg-danger-500';
        resultStatusText.textContent = 'è¯†åˆ«å¤±è´¥';
        resultStatusText.className = 'text-sm font-medium text-danger-600';
      }

      if (result.status === 'success') {
        // æ•´ä½“ç½®ä¿¡åº¦
        const confidencePercent = Math.round(result.confidence * 100);
        overallConfidence.textContent = `${confidencePercent}%`;
        overallConfidence.className = `text-sm font-semibold ${getConfidenceColor(result.confidence)}`;
        confidenceBar.style.width = confidencePercent + '%';
        confidenceBar.className = `progress-fill ${getConfidenceColor(result.confidence).replace('text-', 'bg-')}`;

        // è¯†åˆ«æ ‡ç­¾
        recognitionTags.innerHTML = '';
        result.predictions.forEach(prediction => {
          const tag = document.createElement('span');
          tag.className = `recognition-tag ${getTagClass(prediction.label)}`;
          tag.textContent = prediction.label;
          recognitionTags.appendChild(tag);
        });

        // è¯¦ç»†ç»“æœ
        detailedResults.innerHTML = '';
        result.predictions.forEach(prediction => {
          const item = document.createElement('div');
          item.className = 'flex items-center justify-between p-3 bg-gray-50 rounded-lg';
          item.innerHTML = `
            <span class="text-sm font-medium text-gray-900">${prediction.label}</span>
            <div class="flex items-center space-x-2">
              <span class="text-sm ${getConfidenceColor(prediction.confidence)}">${Math.round(prediction.confidence * 100)}%</span>
              <span class="text-xs text-gray-500">${getConfidenceText(prediction.confidence)}</span>
            </div>
          `;
          detailedResults.appendChild(item);
        });

        // é®æŒ¡ç¨‹åº¦åˆ†æ
        const coveragePredictions = result.predictions.filter(p => p.label !== 'æ­£å¸¸å…‰ä¼æ¿' && p.label !== 'äº‘å½©é˜´å½±');
        if (coveragePredictions.length > 0) {
          const totalConfidence = coveragePredictions.reduce((sum, p) => sum + p.confidence, 0);
          const avgConfidence = totalConfidence / coveragePredictions.length;
          const percentage = Math.round(avgConfidence * 100);
          
          let level, description, bgColor;
          if (percentage >= 70) {
            level = 'high';
            description = 'ä¸¥é‡é®æŒ¡';
            bgColor = 'bg-danger-50 border-danger-200';
          } else if (percentage >= 40) {
            level = 'medium';
            description = 'ä¸­åº¦é®æŒ¡';
            bgColor = 'bg-warning-50 border-warning-200';
          } else {
            level = 'low';
            description = 'è½»å¾®é®æŒ¡';
            bgColor = 'bg-success-50 border-success-200';
          }
          
          coverageAnalysis.innerHTML = `
            <div class="p-4 rounded-lg border ${bgColor}">
              <div class="flex items-center justify-between mb-2">
                <span class="text-sm font-medium text-gray-900">é®æŒ¡ç¨‹åº¦</span>
                <span class="text-sm font-semibold ${getConfidenceColor(avgConfidence)}">${percentage}%</span>
              </div>
              <div class="text-sm text-gray-600">${description}</div>
            </div>
          `;
        } else {
          coverageAnalysis.innerHTML = `
            <div class="p-4 rounded-lg border bg-success-50 border-success-200">
              <div class="text-sm font-medium text-success-800">æ— é®æŒ¡</div>
              <div class="text-sm text-success-600">å…‰ä¼æ¿çŠ¶æ€è‰¯å¥½</div>
            </div>
          `;
        }

        // æ¸…æ´å»ºè®®
        let advice = '';
        result.predictions.forEach(prediction => {
          switch (prediction.label) {
            case 'æ­£å¸¸å…‰ä¼æ¿':
              advice += 'âœ… æ£€æµ‹åˆ°æ­£å¸¸å·¥ä½œçš„å…‰ä¼æ¿ã€‚';
              break;
            case 'æ ‘å¶é®æŒ¡':
              advice += ' ğŸƒ å‘ç°æ ‘å¶é®æŒ¡ï¼Œå»ºè®®åŠæ—¶æ¸…ç†ä»¥ä¿æŒå‘ç”µæ•ˆç‡ã€‚';
              break;
            case 'ç°å°˜è¦†ç›–':
              advice += ' ğŸ§¹ æ£€æµ‹åˆ°ç°å°˜è¦†ç›–ï¼Œå»ºè®®å®šæœŸæ¸…æ´å…‰ä¼æ¿è¡¨é¢ã€‚';
              break;
            case 'äº‘å½©é˜´å½±':
              advice += ' â˜ï¸ äº‘å½©é˜´å½±å½±å“å‘ç”µï¼Œè¿™æ˜¯æ­£å¸¸ç°è±¡ã€‚';
              break;
            default:
              advice += ' âš ï¸ å‘ç°å…¶ä»–å¼‚ç‰©ï¼Œå»ºè®®æ£€æŸ¥å¹¶æ¸…ç†ã€‚';
          }
        });
        
        cleaningAdvice.querySelector('p').textContent = advice || 'è¯†åˆ«å®Œæˆï¼Œè¯·æŸ¥çœ‹è¯¦ç»†ç»“æœã€‚';
      } else {
        // é”™è¯¯æƒ…å†µ
        overallConfidence.textContent = '0%';
        recognitionTags.innerHTML = '<span class="text-sm text-gray-500">è¯†åˆ«å¤±è´¥</span>';
        detailedResults.innerHTML = '<div class="text-sm text-gray-500">æ— æ³•è·å–è¯†åˆ«ç»“æœ</div>';
        coverageAnalysis.innerHTML = '<div class="text-sm text-gray-500">æ— æ³•åˆ†æé®æŒ¡ç¨‹åº¦</div>';
        cleaningAdvice.querySelector('p').textContent = result.error_message || 'è¯†åˆ«è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯ï¼Œè¯·é‡è¯•ã€‚';
      }

      recognitionResultDiv.classList.remove('hidden');
    }

    // å¼€å§‹è¯†åˆ«
    startRecognitionBtn.addEventListener('click', async () => {
      if (!currentFile) return;

      // æ˜¾ç¤ºè¿›åº¦
      recognitionProgress.classList.remove('hidden');
      recognitionResultDiv.classList.add('hidden');
      startRecognitionBtn.disabled = true;

      try {
        // ä¸Šä¼ å›¾ç‰‡åˆ°Supabase Storage
        const formData = new FormData();
        formData.append('file', currentFile);
        
        // æ¨¡æ‹Ÿä¸Šä¼ è¿‡ç¨‹
        await simulateRecognition();
        
        // è°ƒç”¨è¯†åˆ«API
        const imageUrl = await uploadImageToStorage(currentFile);
        
        const response = await fetch('/.netlify/functions/recognition', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ imageUrl }),
        });

        if (!response.ok) {
          throw new Error(`APIè°ƒç”¨å¤±è´¥: ${response.status}`);
        }

        const result = await response.json();
        
        // æ˜¾ç¤ºç»“æœ
        displayResult(result);
        
        // ä¿å­˜åˆ°æ•°æ®åº“
        if (result.status === 'success') {
          await saveRecognitionRecord({
            image_url: imageUrl,
            image_name: currentFile.name,
            recognition_result: result,
            processing_time: result.processing_time
          });
        }
        
      } catch (error) {
        console.error('è¯†åˆ«é”™è¯¯:', error);
        displayResult({
          status: 'error',
          predictions: [],
          confidence: 0,
          processing_time: 0,
          api_used: 'error',
          error_message: 'è¯†åˆ«è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯ï¼Œè¯·é‡è¯•ã€‚'
        });
      } finally {
        // éšè—è¿›åº¦
        recognitionProgress.classList.add('hidden');
        startRecognitionBtn.disabled = false;
      }
    });

    // ä¸Šä¼ å›¾ç‰‡åˆ°å­˜å‚¨
    async function uploadImageToStorage(file) {
      try {
        // è¿™é‡Œåº”è¯¥è°ƒç”¨Supabase Storage API
        // ä¸ºäº†æ¼”ç¤ºï¼Œæˆ‘ä»¬è¿”å›ä¸€ä¸ªæ¨¡æ‹Ÿçš„URL
        const timestamp = Date.now();
        const fileName = `solar-${timestamp}-${file.name}`;
        
        // åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿™é‡Œåº”è¯¥æ˜¯çœŸå®çš„Supabase Storage URL
        return `https://example.supabase.co/storage/v1/object/public/solar-images/${fileName}`;
      } catch (error) {
        console.error('å›¾ç‰‡ä¸Šä¼ å¤±è´¥:', error);
        throw error;
      }
    }

    // ä¿å­˜è¯†åˆ«è®°å½•
    async function saveRecognitionRecord(record) {
      try {
        // è¿™é‡Œåº”è¯¥è°ƒç”¨æ•°æ®åº“APIä¿å­˜è®°å½•
        console.log('ä¿å­˜è¯†åˆ«è®°å½•:', record);
        // åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿™é‡Œåº”è¯¥è°ƒç”¨Supabase API
      } catch (error) {
        console.error('ä¿å­˜è®°å½•å¤±è´¥:', error);
      }
    }

    // ä¿å­˜ç»“æœ
    saveResultBtn.addEventListener('click', () => {
      if (!recognitionResult) return;
      
      // è¿™é‡Œå¯ä»¥è°ƒç”¨APIä¿å­˜ç»“æœåˆ°æ•°æ®åº“
      alert('ç»“æœå·²ä¿å­˜åˆ°è¯†åˆ«å†å²');
    });

    // åˆ†äº«ç»“æœ
    shareResultBtn.addEventListener('click', () => {
      if (!recognitionResult) return;
      
      // ç”Ÿæˆåˆ†äº«é“¾æ¥
      const shareText = `æˆ‘åˆšåˆšä½¿ç”¨å…‰ä¼å›¾åƒè¯†åˆ«å·¥å…·åˆ†æäº†å…‰ä¼æ¿çŠ¶æ€ï¼Œè¯†åˆ«ç»“æœï¼š${recognitionResult.predictions.map(p => p.label).join('ã€')}`;
      
      if (navigator.share) {
        navigator.share({
          title: 'å…‰ä¼å›¾åƒè¯†åˆ«ç»“æœ',
          text: shareText,
          url: window.location.href
        });
      } else {
        // å¤åˆ¶åˆ°å‰ªè´´æ¿
        navigator.clipboard.writeText(shareText).then(() => {
          alert('åˆ†äº«å†…å®¹å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
        });
      }
    });
  </script>
</Layout>

