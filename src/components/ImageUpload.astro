---
// ImageUpload组件
export interface Props {
  onFileSelect?: (file: File) => void;
  onFileRemove?: () => void;
  disabled?: boolean;
}

const { onFileSelect, onFileRemove, disabled = false } = Astro.props;
---

<div class="card">
  <div class="card-header">
    <h2 class="text-lg font-semibold text-gray-900">上传图片</h2>
    <p class="text-sm text-gray-600 mt-1">支持 JPG、PNG、WebP 格式，最大 10MB</p>
  </div>
  <div class="card-body">
    <!-- 上传区域 -->
    <div id="upload-area" class="upload-area" class:opacity-50={disabled}>
      <div class="text-center">
        <svg class="w-12 h-12 text-gray-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
        </svg>
        <p class="text-lg font-medium text-gray-900 mb-2">拖拽图片到此处或点击上传</p>
        <p class="text-sm text-gray-500">支持 JPG、PNG、WebP 格式</p>
        <input type="file" id="file-input" class="hidden" accept="image/*" {disabled} />
      </div>
    </div>
    
    <!-- 图片预览 -->
    <div id="image-preview" class="hidden mt-4">
      <img id="preview-img" class="w-full h-64 object-cover rounded-lg" alt="预览图片" />
      <div class="mt-4 flex justify-between items-center">
        <div>
          <p id="file-name" class="text-sm font-medium text-gray-900"></p>
          <p id="file-size" class="text-sm text-gray-500"></p>
        </div>
        <button id="remove-image" class="btn btn-danger text-sm" {disabled}>
          移除图片
        </button>
      </div>
    </div>
  </div>
</div>

<script define:vars={{ onFileSelect, onFileRemove, disabled }}>
  // DOM元素
  const uploadArea = document.getElementById('upload-area');
  const fileInput = document.getElementById('file-input');
  const imagePreview = document.getElementById('image-preview');
  const previewImg = document.getElementById('preview-img');
  const fileName = document.getElementById('file-name');
  const fileSize = document.getElementById('file-size');
  const removeImageBtn = document.getElementById('remove-image');

  // 工具函数
  function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
  }

  // 文件处理
  function handleFile(file) {
    if (disabled) return;
    
    // 验证文件
    const maxSize = 10 * 1024 * 1024; // 10MB
    const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/webp'];
    
    if (!allowedTypes.includes(file.type)) {
      alert('只支持 JPG、PNG、WebP 格式的图片');
      return;
    }
    
    if (file.size > maxSize) {
      alert('图片大小不能超过 10MB');
      return;
    }

    // 显示预览
    const reader = new FileReader();
    reader.onload = (e) => {
      previewImg.src = e.target.result;
      fileName.textContent = file.name;
      fileSize.textContent = formatFileSize(file.size);
      imagePreview.classList.remove('hidden');
    };
    reader.readAsDataURL(file);

    // 调用回调函数
    if (onFileSelect) {
      onFileSelect(file);
    }
  }

  // 事件监听器
  uploadArea.addEventListener('click', () => {
    if (!disabled) {
      fileInput.click();
    }
  });
  
  uploadArea.addEventListener('dragover', (e) => {
    if (disabled) return;
    e.preventDefault();
    uploadArea.classList.add('dragover');
  });
  
  uploadArea.addEventListener('dragleave', () => {
    uploadArea.classList.remove('dragover');
  });
  
  uploadArea.addEventListener('drop', (e) => {
    if (disabled) return;
    e.preventDefault();
    uploadArea.classList.remove('dragover');
    const files = e.dataTransfer.files;
    if (files.length > 0) {
      handleFile(files[0]);
    }
  });

  fileInput.addEventListener('change', (e) => {
    if (e.target.files.length > 0) {
      handleFile(e.target.files[0]);
    }
  });

  removeImageBtn.addEventListener('click', () => {
    imagePreview.classList.add('hidden');
    fileInput.value = '';
    
    // 调用回调函数
    if (onFileRemove) {
      onFileRemove();
    }
  });
</script>
