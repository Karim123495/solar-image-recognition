---
// RecognitionResultç»„ä»¶
export interface Props {
  result?: any;
  loading?: boolean;
}

const { result, loading = false } = Astro.props;
---

<div class="card">
  <div class="card-header">
    <h2 class="text-lg font-semibold text-gray-900">è¯†åˆ«ç»“æœ</h2>
    <div class="flex items-center space-x-2">
      <div id="result-status" class="w-3 h-3 rounded-full"></div>
      <span id="result-status-text" class="text-sm font-medium"></span>
    </div>
  </div>
  <div class="card-body">
    {loading ? (
      <div class="text-center py-8">
        <div class="loading-spinner mx-auto mb-4"></div>
        <h3 class="text-lg font-semibold text-gray-900 mb-2">AIæ­£åœ¨åˆ†æå›¾ç‰‡...</h3>
        <p class="text-gray-600 mb-4">è¯·ç¨å€™ï¼Œè¿™é€šå¸¸éœ€è¦å‡ ç§’é’Ÿæ—¶é—´</p>
      </div>
    ) : result ? (
      <>
        <!-- æ•´ä½“ç½®ä¿¡åº¦ -->
        <div class="mb-6">
          <div class="flex items-center justify-between mb-2">
            <span class="text-sm font-medium text-gray-700">æ•´ä½“ç½®ä¿¡åº¦</span>
            <span id="overall-confidence" class="text-sm font-semibold"></span>
          </div>
          <div class="progress-bar">
            <div id="confidence-bar" class="progress-fill"></div>
          </div>
        </div>

        <!-- è¯†åˆ«æ ‡ç­¾ -->
        <div class="mb-6">
          <h3 class="text-sm font-medium text-gray-700 mb-3">è¯†åˆ«æ ‡ç­¾</h3>
          <div id="recognition-tags" class="flex flex-wrap gap-2"></div>
        </div>

        <!-- è¯¦ç»†ç»“æœ -->
        <div class="mb-6">
          <h3 class="text-sm font-medium text-gray-700 mb-3">è¯¦ç»†ç»“æœ</h3>
          <div id="detailed-results" class="space-y-3"></div>
        </div>

        <!-- é®æŒ¡ç¨‹åº¦åˆ†æ -->
        <div class="mb-6">
          <h3 class="text-sm font-medium text-gray-700 mb-3">é®æŒ¡ç¨‹åº¦åˆ†æ</h3>
          <div id="coverage-analysis" class="p-4 rounded-lg"></div>
        </div>

        <!-- æ¸…æ´å»ºè®® -->
        <div>
          <h3 class="text-sm font-medium text-gray-700 mb-3">æ¸…æ´å»ºè®®</h3>
          <div id="cleaning-advice" class="p-4 bg-blue-50 rounded-lg">
            <p class="text-sm text-blue-800"></p>
          </div>
        </div>
      </>
    ) : (
      <div class="text-center py-8">
        <svg class="w-16 h-16 text-gray-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
        </svg>
        <h3 class="text-lg font-medium text-gray-900 mb-2">ç­‰å¾…è¯†åˆ«ç»“æœ</h3>
        <p class="text-gray-600">è¯·ä¸Šä¼ å›¾ç‰‡å¹¶å¼€å§‹è¯†åˆ«</p>
      </div>
    )}
  </div>
  {result && (
    <div class="card-footer">
      <div class="flex space-x-3">
        <button id="save-result" class="btn btn-primary flex-1">
          <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" />
          </svg>
          ä¿å­˜ç»“æœ
        </button>
        <button id="share-result" class="btn btn-secondary flex-1">
          <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.367 2.684 3 3 0 00-5.367-2.684z" />
          </svg>
          åˆ†äº«ç»“æœ
        </button>
      </div>
    </div>
  )}
</div>

<script define:vars={{ result }}>
  // å·¥å…·å‡½æ•°
  function getConfidenceColor(confidence) {
    if (confidence >= 0.8) return 'text-success-600';
    if (confidence >= 0.6) return 'text-warning-600';
    return 'text-danger-600';
  }

  function getConfidenceText(confidence) {
    if (confidence >= 0.8) return 'é«˜';
    if (confidence >= 0.6) return 'ä¸­';
    return 'ä½';
  }

  function getTagClass(label) {
    switch (label) {
      case 'æ­£å¸¸å…‰ä¼æ¿': return 'tag-normal';
      case 'æ ‘å¶é®æŒ¡': return 'tag-leaf';
      case 'ç°å°˜è¦†ç›–': return 'tag-dust';
      case 'äº‘å½©é˜´å½±': return 'tag-cloud';
      default: return 'tag-other';
    }
  }

  // æ˜¾ç¤ºè¯†åˆ«ç»“æœ
  function displayResult(result) {
    if (!result) return;

    // DOMå…ƒç´ 
    const resultStatus = document.getElementById('result-status');
    const resultStatusText = document.getElementById('result-status-text');
    const overallConfidence = document.getElementById('overall-confidence');
    const confidenceBar = document.getElementById('confidence-bar');
    const recognitionTags = document.getElementById('recognition-tags');
    const detailedResults = document.getElementById('detailed-results');
    const coverageAnalysis = document.getElementById('coverage-analysis');
    const cleaningAdvice = document.getElementById('cleaning-advice');

    // çŠ¶æ€æŒ‡ç¤ºå™¨
    if (result.status === 'success') {
      resultStatus.className = 'w-3 h-3 rounded-full bg-success-500';
      resultStatusText.textContent = 'è¯†åˆ«æˆåŠŸ';
      resultStatusText.className = 'text-sm font-medium text-success-600';
    } else {
      resultStatus.className = 'w-3 h-3 rounded-full bg-danger-500';
      resultStatusText.textContent = 'è¯†åˆ«å¤±è´¥';
      resultStatusText.className = 'text-sm font-medium text-danger-600';
    }

    if (result.status === 'success') {
      // æ•´ä½“ç½®ä¿¡åº¦
      const confidencePercent = Math.round(result.confidence * 100);
      overallConfidence.textContent = `${confidencePercent}%`;
      overallConfidence.className = `text-sm font-semibold ${getConfidenceColor(result.confidence)}`;
      confidenceBar.style.width = confidencePercent + '%';
      confidenceBar.className = `progress-fill ${getConfidenceColor(result.confidence).replace('text-', 'bg-')}`;

      // è¯†åˆ«æ ‡ç­¾
      recognitionTags.innerHTML = '';
      result.predictions.forEach(prediction => {
        const tag = document.createElement('span');
        tag.className = `recognition-tag ${getTagClass(prediction.label)}`;
        tag.textContent = prediction.label;
        recognitionTags.appendChild(tag);
      });

      // è¯¦ç»†ç»“æœ
      detailedResults.innerHTML = '';
      result.predictions.forEach(prediction => {
        const item = document.createElement('div');
        item.className = 'flex items-center justify-between p-3 bg-gray-50 rounded-lg';
        item.innerHTML = `
          <span class="text-sm font-medium text-gray-900">${prediction.label}</span>
          <div class="flex items-center space-x-2">
            <span class="text-sm ${getConfidenceColor(prediction.confidence)}">${Math.round(prediction.confidence * 100)}%</span>
            <span class="text-xs text-gray-500">${getConfidenceText(prediction.confidence)}</span>
          </div>
        `;
        detailedResults.appendChild(item);
      });

      // é®æŒ¡ç¨‹åº¦åˆ†æ
      const coveragePredictions = result.predictions.filter(p => p.label !== 'æ­£å¸¸å…‰ä¼æ¿' && p.label !== 'äº‘å½©é˜´å½±');
      if (coveragePredictions.length > 0) {
        const totalConfidence = coveragePredictions.reduce((sum, p) => sum + p.confidence, 0);
        const avgConfidence = totalConfidence / coveragePredictions.length;
        const percentage = Math.round(avgConfidence * 100);
        
        let level, description, bgColor;
        if (percentage >= 70) {
          level = 'high';
          description = 'ä¸¥é‡é®æŒ¡';
          bgColor = 'bg-danger-50 border-danger-200';
        } else if (percentage >= 40) {
          level = 'medium';
          description = 'ä¸­åº¦é®æŒ¡';
          bgColor = 'bg-warning-50 border-warning-200';
        } else {
          level = 'low';
          description = 'è½»å¾®é®æŒ¡';
          bgColor = 'bg-success-50 border-success-200';
        }
        
        coverageAnalysis.innerHTML = `
          <div class="p-4 rounded-lg border ${bgColor}">
            <div class="flex items-center justify-between mb-2">
              <span class="text-sm font-medium text-gray-900">é®æŒ¡ç¨‹åº¦</span>
              <span class="text-sm font-semibold ${getConfidenceColor(avgConfidence)}">${percentage}%</span>
            </div>
            <div class="text-sm text-gray-600">${description}</div>
          </div>
        `;
      } else {
        coverageAnalysis.innerHTML = `
          <div class="p-4 rounded-lg border bg-success-50 border-success-200">
            <div class="text-sm font-medium text-success-800">æ— é®æŒ¡</div>
            <div class="text-sm text-success-600">å…‰ä¼æ¿çŠ¶æ€è‰¯å¥½</div>
          </div>
        `;
      }

      // æ¸…æ´å»ºè®®
      let advice = '';
      result.predictions.forEach(prediction => {
        switch (prediction.label) {
          case 'æ­£å¸¸å…‰ä¼æ¿':
            advice += 'âœ… æ£€æµ‹åˆ°æ­£å¸¸å·¥ä½œçš„å…‰ä¼æ¿ã€‚';
            break;
          case 'æ ‘å¶é®æŒ¡':
            advice += ' ğŸƒ å‘ç°æ ‘å¶é®æŒ¡ï¼Œå»ºè®®åŠæ—¶æ¸…ç†ä»¥ä¿æŒå‘ç”µæ•ˆç‡ã€‚';
            break;
          case 'ç°å°˜è¦†ç›–':
            advice += ' ğŸ§¹ æ£€æµ‹åˆ°ç°å°˜è¦†ç›–ï¼Œå»ºè®®å®šæœŸæ¸…æ´å…‰ä¼æ¿è¡¨é¢ã€‚';
            break;
          case 'äº‘å½©é˜´å½±':
            advice += ' â˜ï¸ äº‘å½©é˜´å½±å½±å“å‘ç”µï¼Œè¿™æ˜¯æ­£å¸¸ç°è±¡ã€‚';
            break;
          default:
            advice += ' âš ï¸ å‘ç°å…¶ä»–å¼‚ç‰©ï¼Œå»ºè®®æ£€æŸ¥å¹¶æ¸…ç†ã€‚';
        }
      });
      
      cleaningAdvice.querySelector('p').textContent = advice || 'è¯†åˆ«å®Œæˆï¼Œè¯·æŸ¥çœ‹è¯¦ç»†ç»“æœã€‚';
    } else {
      // é”™è¯¯æƒ…å†µ
      overallConfidence.textContent = '0%';
      recognitionTags.innerHTML = '<span class="text-sm text-gray-500">è¯†åˆ«å¤±è´¥</span>';
      detailedResults.innerHTML = '<div class="text-sm text-gray-500">æ— æ³•è·å–è¯†åˆ«ç»“æœ</div>';
      coverageAnalysis.innerHTML = '<div class="text-sm text-gray-500">æ— æ³•åˆ†æé®æŒ¡ç¨‹åº¦</div>';
      cleaningAdvice.querySelector('p').textContent = result.error_message || 'è¯†åˆ«è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯ï¼Œè¯·é‡è¯•ã€‚';
    }
  }

  // äº‹ä»¶ç›‘å¬å™¨
  document.getElementById('save-result')?.addEventListener('click', () => {
    alert('ç»“æœå·²ä¿å­˜åˆ°è¯†åˆ«å†å²');
  });

  document.getElementById('share-result')?.addEventListener('click', () => {
    if (!result) return;
    
    const shareText = `æˆ‘åˆšåˆšä½¿ç”¨å…‰ä¼å›¾åƒè¯†åˆ«å·¥å…·åˆ†æäº†å…‰ä¼æ¿çŠ¶æ€ï¼Œè¯†åˆ«ç»“æœï¼š${result.predictions.map(p => p.label).join('ã€')}`;
    
    if (navigator.share) {
      navigator.share({
        title: 'å…‰ä¼å›¾åƒè¯†åˆ«ç»“æœ',
        text: shareText,
        url: window.location.href
      });
    } else {
      navigator.clipboard.writeText(shareText).then(() => {
        alert('åˆ†äº«å†…å®¹å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
      });
    }
  });

  // åˆå§‹åŒ–æ˜¾ç¤ºç»“æœ
  if (result) {
    displayResult(result);
  }
</script>
